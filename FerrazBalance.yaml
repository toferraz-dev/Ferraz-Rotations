version: 3.1
author: Ferraz
patch: "12.0.1"
spec: 102
name: Balance Elunes
description: |
  Balance Druid - Elunes Chosen for Mythic+.
  Supports Wowhead (aggressive DPS) / Method.gg (balanced) rotation styles.
  Talent Tree: CYGAOB00+EWim5ji+N0ScDXt8DAAAAAAAAAAAAAAAAWoMbNjxMDwsYmZGLMMMmZZmFzMzsMWmZZMzgFMMAjFzMgxIwEAAAgFzMmZwmhxYAAYmBA
  
entry: main

# ============================================================
#  CONFIGURATION
# ============================================================
config:

  # --- Rotation Style ---
  rotation_source:
    label: "Rotation Style"
    type: dropdown
    options:
      - label: "Wowhead (Aggressive DPS)"
        value: 1
      - label: "Method.gg (Balanced)"
        value: 2
    default: 2

  # --- Astral Power ---
  starfall_aoe_threshold:
    label: "Min enemies for Starfall"
    type: slider
    min: 2
    max: 5
    default: 2
  astral_power_dump_threshold:
    label: "AP to dump (avoid overcap)"
    type: slider
    min: 60
    max: 100
    default: 80

  # --- Cooldowns ---
  incarnation_enemies:
    label: "Min enemies for Incarnation"
    type: slider
    min: 1
    max: 10
    default: 3
  fury_of_elune_enemies:
    label: "Min enemies for Fury of Elune"
    type: slider
    min: 1
    max: 5
    default: 1

  # --- Interrupts ---
  use_solar_beam:
    label: "Auto Solar Beam"
    type: checkbox
    default: true
  solar_beam_delay:
    label: "Solar Beam Delay (ms)"
    type: slider
    min: 0
    max: 2000
    default: 250
  use_typhoon:
    label: "Typhoon on Interrupt"
    type: checkbox
    default: false

  # --- Defensives ---
  barkskin_threshold:
    label: "HP% for Barkskin"
    type: slider
    min: 20
    max: 80
    default: 50

  # --- Heal Support ---
  enable_heart_of_the_wild:
    label: "Heart of the Wild (heal party)"
    type: checkbox
    default: true
  hotw_party_hp_threshold:
    label: "Party HP% to trigger HotW"
    type: slider
    min: 30
    max: 90
    default: 80

  # --- Utility ---
  use_shadowmeld:
    label: "Shadowmeld (aggro drop)"
    type: checkbox
    default: true
  shadowmeld_threat:
    label: "Threat level for Shadowmeld"
    type: slider
    min: 2
    max: 3
    default: 3
  use_incapacitating_roar:
    label: "Incapacitating Roar (AoE CC)"
    type: checkbox
    default: false

  # --- Movement ---
  stampeding_roar_usage:
    label: "Stampeding Roar Usage"
    type: dropdown
    options:
      - label: "Disabled"
        value: 0
      - label: "Only in combat"
        value: 1
      - label: "Only out of combat"
        value: 2
      - label: "Always when moving"
        value: 3
    default: 2
  stampeding_roar_movement_time:
    label: "Roar after moving (seconds)"
    type: slider
    min: 0
    max: 4
    default: 2

  # --- Trinkets ---
  trinket_usage:
    label: "Trinket Usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "With Incarnation"
        value: 2
      - label: "Manual Only"
        value: 0
    default: 1

# ============================================================
#  ACTION LISTS
# ============================================================
lists:

  # ----------------------------------------------------------
  #  SYSTEM
  # ----------------------------------------------------------

  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs

  # ----------------------------------------------------------
  #  BUFFS
  # ----------------------------------------------------------

  buff_mark_of_the_wild:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>0&cycle.range<=40)>0

  moonkin_form:
    - moonkin_form,if=!buff.moonkin_form.up&!mounted.flying&!mounted.ground

  # ----------------------------------------------------------
  #  DOTS (maintain on current target)
  # ----------------------------------------------------------

  dots:
    - sunfire,if=debuff.sunfire.down
    - sunfire,if=debuff.sunfire.remains<3.6
    - moonfire,if=debuff.moonfire.down
    - moonfire,if=debuff.moonfire.remains<4.8

  dot_spread:
    - sunfire,if=debuff.sunfire.down
    - moonfire,if=debuff.moonfire.down

  # ----------------------------------------------------------
  #  COOLDOWNS
  # ----------------------------------------------------------

  cooldowns:
    # Incarnation: Chosen of Elune (major CD — both eclipses + crit)
    - incarnation_chosen_of_elune,if=active_enemies>=config.incarnation_enemies&!buff.incarnation_chosen_of_elune.up|(target.boss&target.time_to_die>20&!buff.incarnation_chosen_of_elune.up)
    # Celestial Alignment fallback
    - celestial_alignment,if=!talent.incarnation_chosen_of_elune&(active_enemies>=config.incarnation_enemies&!buff.celestial_alignment.up|(target.boss&target.time_to_die>20&!buff.celestial_alignment.up))


  # ----------------------------------------------------------
  #  DEFENSIVES
  # ----------------------------------------------------------

  defensives:
    - barkskin,if=health.pct<config.barkskin_threshold&!buff.barkskin.up
    - shadowmeld,if=config.use_shadowmeld&target.threat>=config.shadowmeld_threat&!target.boss

  # ----------------------------------------------------------
  #  HEAL SUPPORT (Heart of the Wild)
  # ----------------------------------------------------------

  heal_support:
    - heart_of_the_wild,if=config.enable_heart_of_the_wild&group.lowest.health.pct<config.hotw_party_hp_threshold&!buff.heart_of_the_wild.up&cooldown.heart_of_the_wild.ready
    - regrowth,target=lowest,if=buff.heart_of_the_wild.up&group.lowest.health.pct<config.hotw_party_hp_threshold

  # ----------------------------------------------------------
  #  INTERRUPTS & UTILITY
  # ----------------------------------------------------------

  interrupts:
    - solar_beam,if=config.use_solar_beam&target.casting&target.casting.interruptible,delay=config.solar_beam_delay
    - typhoon,if=config.use_typhoon&target.casting&target.casting.interruptible&target.range<=15
    - incapacitating_roar,if=config.use_incapacitating_roar&active_enemies>=3&target.casting&target.casting.interruptible
    - soothe,if=target.purgeable.enrage

  dispel:
    - remove_corruption,cycle=party,if=cycle.dispelable.curse|cycle.dispelable.poison

  # ----------------------------------------------------------
  #  TRINKETS & MOVEMENT
  # ----------------------------------------------------------

  trinkets:
    - trinket_1,if=trinket_1.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)))
    - trinket_2,if=trinket_2.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)))

  movement:
    - stampeding_roar,if=moving.time>=config.stampeding_roar_movement_time&buff.stampeding_roar.down&((config.stampeding_roar_usage=1&player.combat)|(config.stampeding_roar_usage=2&!player.combat)|(config.stampeding_roar_usage=3))&config.stampeding_roar_usage!=0

  # ==========================================================
  #  ROTATIONS
  # ==========================================================

  # ----------------------------------------------------------
  #  WOWHEAD — Aggressive DPS (Single Target)
  # ----------------------------------------------------------

  rotation_st_wowhead:
    # Maintain DoTs (Top Priority)
    - sunfire,if=debuff.sunfire.down
    - sunfire,if=debuff.sunfire.remains<3.6
    - moonfire,if=debuff.moonfire.down
    - moonfire,if=debuff.moonfire.remains<4.8
    # Fury of Elune (Before Incarnation)
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Cooldowns (Incarnation / CA)
    - call_action_list,name=cooldowns
    # Activate Lunar Eclipse if available and not in any Eclipse
    - lunar_eclipse,if=cooldown.lunar_eclipse.ready&!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Burst Spender (First 6s of Eclipse or Incarnation)
    - starsurge,if=(buff.eclipse_solar.remains>9|buff.eclipse_lunar.remains>9|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starsurge — dump AP to avoid overcap
    - starsurge,if=astral_power>=config.astral_power_dump_threshold
    # Starsurge — maintain Star-Lord stacks
    - starsurge,if=buff.starlord.stack<3&astral_power>=30
    # Starfire in Lunar Eclipse (main filler during Eclipse window)
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Starfire to set up next Lunar Eclipse (cast before pressing Eclipse button)
    - starfire,if=cooldown.lunar_eclipse.remains<3&!buff.eclipse_lunar.up
    # Wrath as default filler (outside Eclipse)
    - wrath

  # ----------------------------------------------------------
  #  WOWHEAD — Aggressive DPS (AoE)
  # ----------------------------------------------------------

  rotation_aoe_wowhead:
    # Maintain DoTs on all targets (Top Priority)
    - sunfire,if=debuff.sunfire.down
    - sunfire,if=debuff.sunfire.remains<3.6
    - moonfire,if=debuff.moonfire.down
    - moonfire,if=debuff.moonfire.remains<4.8
    # Fury of Elune (high AoE priority)
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Cooldowns (Incarnation / CA)
    - call_action_list,name=cooldowns
    # Activate Lunar Eclipse if available
    - lunar_eclipse,if=cooldown.lunar_eclipse.ready&!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Burst Spender (First 6s of Eclipse or Incarnation)
    - starfall,if=(buff.eclipse_solar.remains>9|buff.eclipse_lunar.remains>9|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=50
    # Starfall uptime — main AoE spender
    - starfall,if=!buff.starfall.up&astral_power>=50
    - starfall,if=astral_power>=config.astral_power_dump_threshold
    # Starsurge to maintain Star-Lord during burst
    - starsurge,if=buff.starlord.stack<3&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starfire — AoE filler in Lunar Eclipse (cleaves with Starfall)
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Starfire to set up next Lunar Eclipse
    - starfire,if=cooldown.lunar_eclipse.remains<3&!buff.eclipse_lunar.up
    # Wrath as default filler
    - wrath

  # ----------------------------------------------------------
  #  METHOD.GG — Balanced (Single Target)
  # ----------------------------------------------------------

  rotation_st_method:
    # Maintain DoTs first
    - sunfire,if=debuff.sunfire.down
    - sunfire,if=debuff.sunfire.remains<3.6
    - moonfire,if=debuff.moonfire.down
    - moonfire,if=debuff.moonfire.remains<4.8
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Cooldowns (Incarnation / CA)
    - call_action_list,name=cooldowns
    # Activate Lunar Eclipse if available
    - lunar_eclipse,if=cooldown.lunar_eclipse.ready&!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Burst Spender (First 6s of Eclipse or Incarnation)
    - starsurge,if=(buff.eclipse_solar.remains>9|buff.eclipse_lunar.remains>9|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starsurge — maintain Star-Lord
    - starsurge,if=buff.starlord.stack<3&astral_power>=30
    # Starsurge — avoid overcap
    - starsurge,if=astral_power>=config.astral_power_dump_threshold
    # Starfire in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Starfire to set up next Lunar Eclipse
    - starfire,if=cooldown.lunar_eclipse.remains<3&!buff.eclipse_lunar.up
    # Wrath as default filler
    - wrath

  # ----------------------------------------------------------
  #  METHOD.GG — Balanced (AoE)
  # ----------------------------------------------------------

  rotation_aoe_method:
    # Maintain DoTs on all targets first
    - sunfire,if=debuff.sunfire.down
    - sunfire,if=debuff.sunfire.remains<3.6
    - moonfire,if=debuff.moonfire.down
    - moonfire,if=debuff.moonfire.remains<4.8
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Cooldowns (Incarnation / CA)
    - call_action_list,name=cooldowns
    # Activate Lunar Eclipse if available
    - lunar_eclipse,if=cooldown.lunar_eclipse.ready&!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Burst Spender (First 6s of Eclipse or Incarnation)
    - starfall,if=(buff.eclipse_solar.remains>9|buff.eclipse_lunar.remains>9|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=50
    # Starfall uptime — main AoE spender
    - starfall,if=!buff.starfall.up&astral_power>=50
    - starfall,if=astral_power>=config.astral_power_dump_threshold
    # Starsurge to maintain Star-Lord during burst
    - starsurge,if=buff.starlord.stack<3&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starfire — AoE filler in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Starfire to set up next Lunar Eclipse
    - starfire,if=cooldown.lunar_eclipse.remains<3&!buff.eclipse_lunar.up
    # Wrath as default filler
    - wrath

  # ==========================================================
  #  MAIN ENTRY POINT
  # ==========================================================

  main:
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=buff_mark_of_the_wild
    - call_action_list,name=moonkin_form
    - return,if=!player.combat&active_enemies=0
    - return,if=player.channeling
    - call_action_list,name=auto_target
    - call_action_list,name=auto_heal
    - call_action_list,name=interrupts
    - call_action_list,name=dispel
    - call_action_list,name=defensives
    - call_action_list,name=movement,if=player.moving
    - call_action_list,name=trinkets
    - call_action_list,name=heal_support,if=config.enable_heart_of_the_wild
    - call_action_list,name=rotation_aoe_wowhead,if=config.rotation_source=1&active_enemies>=config.starfall_aoe_threshold&buff.moonkin_form.up
    - call_action_list,name=rotation_st_wowhead,if=config.rotation_source=1&buff.moonkin_form.up
    - call_action_list,name=rotation_aoe_method,if=config.rotation_source=2&active_enemies>=config.starfall_aoe_threshold&buff.moonkin_form.up
    - call_action_list,name=rotation_st_method,if=config.rotation_source=2&buff.moonkin_form.up
