version: 1.0
author: Ferraz
spec: 102
name: Balance Elunes
description: |
  Balance Druid - Elunes Chosen for Mythic+.
  Supports Wowhead (aggressive DPS) / Method.gg (balanced) rotation styles.
  Talent Tree: CYGAOB00+EWim5ji+N0ScDXt8DAAAAAAAAAAAAAAAAWoMbNjxMDwsYmZGLMMMmZZmFzMzsMWmZZMzgFMMAjFzMgxIwEAAAgFzMmZwmhxYAAYmBA
  
entry: main

# ============================================================
#  CONFIGURATION
# ============================================================
config:

  # --- Rotation Style ---
  rotation_source:
    label: "Rotation Style"
    type: dropdown
    options:
      - label: "Wowhead (Aggressive DPS)"
        value: 1
      - label: "Method.gg (Balanced)"
        value: 2
    default: 2

  # --- Astral Power ---
  starfall_aoe_threshold:
    label: "Min enemies for Starfall"
    type: slider
    min: 2
    max: 5
    default: 2
  astral_power_dump_threshold:
    label: "AP to dump (avoid overcap)"
    type: slider
    min: 60
    max: 100
    default: 80

  # --- Cooldowns ---
  incarnation_enemies:
    label: "Min enemies for Incarnation"
    type: slider
    min: 1
    max: 10
    default: 3
  fury_of_elune_enemies:
    label: "Min enemies for Fury of Elune"
    type: slider
    min: 1
    max: 5
    default: 1

  # --- Interrupts ---
  use_solar_beam:
    label: "Auto Solar Beam"
    type: checkbox
    default: true
  solar_beam_delay:
    label: "Solar Beam Delay (ms)"
    type: slider
    min: 0
    max: 2000
    default: 250
  use_typhoon:
    label: "Typhoon on Interrupt"
    type: checkbox
    default: false

  # --- Defensives ---
  barkskin_threshold:
    label: "HP% for Barkskin"
    type: slider
    min: 20
    max: 80
    default: 50

  # --- Movement ---
  stampeding_roar_usage:
    label: "Stampeding Roar Usage"
    type: dropdown
    options:
      - label: "Disabled"
        value: 0
      - label: "Only in combat"
        value: 1
      - label: "Only out of combat"
        value: 2
      - label: "Always when moving"
        value: 3
    default: 2
  stampeding_roar_movement_time:
    label: "Roar after moving (seconds)"
    type: slider
    min: 0
    max: 4
    default: 2

  # --- Trinkets ---
  trinket_usage:
    label: "Trinket Usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "With Incarnation"
        value: 2
      - label: "Manual Only"
        value: 0
    default: 1

# ============================================================
#  ACTION LISTS
# ============================================================
lists:

  # ----------------------------------------------------------
  #  SYSTEM
  # ----------------------------------------------------------

  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs

  # ----------------------------------------------------------
  #  BUFFS
  # ----------------------------------------------------------

  buff_mark_of_the_wild:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>0&cycle.range<=40)>0

  moonkin_form:
    - moonkin_form,if=!buff.moonkin_form.up&!mounted.flying&!mounted.ground

  # ----------------------------------------------------------
  #  ECLIPSE MANAGEMENT
  # ----------------------------------------------------------

  eclipse_management:
    # If not in any Eclipse and not in Incarnation, cast Wrath to enter Lunar Eclipse
    - wrath,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)

  # ----------------------------------------------------------
  #  DOTS (maintain on targets)
  # ----------------------------------------------------------

  dots:
    - sunfire,if=debuff.sunfire.remains<3.6
    - sunfire,if=debuff.sunfire.down
    - moonfire,if=debuff.moonfire.remains<4.8
    - moonfire,if=debuff.moonfire.down

  dot_spread:
    - sunfire,if=debuff.sunfire.down&active_enemies>=2&range<=40
    - moonfire,if=debuff.moonfire.down&active_enemies>=2&range<=40

  # ----------------------------------------------------------
  #  COOLDOWNS
  # ----------------------------------------------------------

  cooldowns:
    # Major cooldown (both eclipses + crit buff)
    - incarnation_chosen_of_elune,if=active_enemies>=config.incarnation_enemies|(target.boss&target.time_to_die>20)
    # Celestial Alignment fallback (if not using Incarnation)
    - celestial_alignment,if=!talent.incarnation_chosen_of_elune&(active_enemies>=config.incarnation_enemies|(target.boss&target.time_to_die>20))
    # Fury of Elune — use on cooldown
    - fury_of_elune,if=active_enemies>=config.fury_of_elune_enemies

  # ----------------------------------------------------------
  #  DEFENSIVES
  # ----------------------------------------------------------

  defensives:
    - barkskin,if=health.pct<config.barkskin_threshold&!buff.barkskin.up

  # ----------------------------------------------------------
  #  INTERRUPTS & UTILITY
  # ----------------------------------------------------------

  interrupts:
    - solar_beam,if=config.use_solar_beam&target.casting&target.casting.interruptible,delay=config.solar_beam_delay
    - typhoon,if=config.use_typhoon&target.casting&target.casting.interruptible&target.range<=15
    - soothe,if=target.purgeable.enrage

  dispel:
    - remove_corruption,cycle=party,if=cycle.dispelable.curse|cycle.dispelable.poison

  # ----------------------------------------------------------
  #  TRINKETS & MOVEMENT
  # ----------------------------------------------------------

  trinkets:
    - trinket_1,if=trinket_1.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)))
    - trinket_2,if=trinket_2.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)))

  movement:
    - stampeding_roar,if=moving.time>=config.stampeding_roar_movement_time&buff.stampeding_roar.down&((config.stampeding_roar_usage=1&player.combat)|(config.stampeding_roar_usage=2&!player.combat)|(config.stampeding_roar_usage=3))&config.stampeding_roar_usage!=0

  # ==========================================================
  #  ROTATIONS
  # ==========================================================

  # ----------------------------------------------------------
  #  WOWHEAD — Aggressive DPS (Single Target)
  # ----------------------------------------------------------

  rotation_st_wowhead:
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Warrior of Elune for instant Starfires
    - warrior_of_elune,if=buff.eclipse_lunar.up&cooldown.warrior_of_elune.ready
    # Enter Lunar Eclipse if not in Eclipse
    - wrath,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Maintain DoTs
    - call_action_list,name=dots
    # Starsurge — high priority to maintain Star-Lord and dump AP
    - starsurge,if=astral_power>=config.astral_power_dump_threshold
    - starsurge,if=buff.starlord.stack<3
    - starsurge,if=(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starfire in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Wrath as filler
    - wrath

  # ----------------------------------------------------------
  #  WOWHEAD — Aggressive DPS (AoE)
  # ----------------------------------------------------------

  rotation_aoe_wowhead:
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Starfall uptime (main AoE spender)
    - starfall,if=!buff.starfall.up&astral_power>=50
    - starfall,if=astral_power>=config.astral_power_dump_threshold
    # Warrior of Elune for instant Starfires
    - warrior_of_elune,if=buff.eclipse_lunar.up&cooldown.warrior_of_elune.ready
    # Enter Lunar Eclipse if not in Eclipse
    - wrath,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Maintain DoTs on all targets
    - call_action_list,name=dot_spread
    - call_action_list,name=dots
    # Starsurge to maintain Star-Lord during Incarnation
    - starsurge,if=buff.starlord.stack<3&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Starfire — AoE filler in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Wrath as filler
    - wrath

  # ----------------------------------------------------------
  #  METHOD.GG — Balanced (Single Target)
  # ----------------------------------------------------------

  rotation_st_method:
    # Maintain DoTs first
    - call_action_list,name=dots
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Warrior of Elune for instant Starfires
    - warrior_of_elune,if=buff.eclipse_lunar.up&cooldown.warrior_of_elune.ready
    # Enter Lunar Eclipse if not in Eclipse
    - wrath,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Starsurge — maintain Star-Lord + avoid overcap
    - starsurge,if=buff.starlord.stack<3
    - starsurge,if=astral_power>=config.astral_power_dump_threshold
    - starsurge,if=(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)&astral_power>=30
    # Starfire in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Wrath as filler
    - wrath

  # ----------------------------------------------------------
  #  METHOD.GG — Balanced (AoE)
  # ----------------------------------------------------------

  rotation_aoe_method:
    # Maintain DoTs on all targets first
    - call_action_list,name=dot_spread
    - call_action_list,name=dots
    # Fury of Elune on CD
    - fury_of_elune,if=cooldown.fury_of_elune.ready
    # Starfall uptime (main AoE spender)
    - starfall,if=!buff.starfall.up&astral_power>=50
    - starfall,if=astral_power>=config.astral_power_dump_threshold
    # Warrior of Elune for instant Starfires
    - warrior_of_elune,if=buff.eclipse_lunar.up&cooldown.warrior_of_elune.ready
    # Enter Lunar Eclipse if not in Eclipse
    - wrath,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Starsurge to maintain Star-Lord during Incarnation
    - starsurge,if=buff.starlord.stack<3&(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Starfire — AoE filler in Lunar Eclipse
    - starfire,if=buff.eclipse_lunar.up|buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up
    # Wrath as filler
    - wrath

  # ==========================================================
  #  MAIN ENTRY POINT
  # ==========================================================

  main:
    # Pre-combat
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=buff_mark_of_the_wild
    - call_action_list,name=moonkin_form
    - return,if=!player.combat&active_enemies=0
    - return,if=player.channeling
    # Targeting & utility
    - call_action_list,name=auto_target
    - call_action_list,name=interrupts
    - call_action_list,name=dispel
    # Eclipse entry (ensure we are in Lunar Eclipse)
    - call_action_list,name=eclipse_management,if=!buff.eclipse_lunar.up&!buff.eclipse_solar.up&!(buff.incarnation_chosen_of_elune.up|buff.celestial_alignment.up)
    # Cooldowns
    - call_action_list,name=cooldowns,if=buff.moonkin_form.up
    # Misc
    - call_action_list,name=movement,if=player.moving
    - call_action_list,name=defensives
    - call_action_list,name=trinkets
    # Rotation (style-dependent)
    - call_action_list,name=rotation_aoe_wowhead,if=config.rotation_source=1&active_enemies>=config.starfall_aoe_threshold&buff.moonkin_form.up
    - call_action_list,name=rotation_st_wowhead,if=config.rotation_source=1&buff.moonkin_form.up
    - call_action_list,name=rotation_aoe_method,if=config.rotation_source=2&active_enemies>=config.starfall_aoe_threshold&buff.moonkin_form.up
    - call_action_list,name=rotation_st_method,if=config.rotation_source=2&buff.moonkin_form.up
