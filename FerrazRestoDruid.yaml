version: 1.0
author: Ferraz
spec: 105
name: Restoration (Beta)
description: |
  Restoration Druid
  Beta Teste

entry: main

config:
  living_silk_members:
    label: "Living Silk - Members"
    type: slider
    min: 1
    max: 5
    default: 3
  living_silk_hp:
    label: "Living Silk HP %"
    type: slider
    min: 30
    max: 80
    default: 70

variables:
  mo_friendly_valid: mouseover.exists&mouseover.alive&mouseover.friendly&mouseover.range>0&mouseover.range<=40
  group_healthy: group.count(cycle.health.pct<90)<2
  can_catweave: var.group_healthy&player.combat
  trinket1_living_silk: trinket_1.id=242393
  trinket2_living_silk: trinket_2.id=242393
  has_living_silk: var.trinket1_living_silk|var.trinket2_living_silk

lists:
  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs
  
  interrupts:
    - incapacitating_roar,if=active_enemies>=2&target.casting.interruptible
  
  out_of_combat:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>0&cycle.range<=40)>0
    - lifebloom,cycle=tanks&!player.combat&cycle.range>0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.down&!player.combat&cycle.range>0&cycle.range<=40
    - regrowth,cycle=members,if=cycle.health.pct<95&!player.combat&cycle.range>0&cycle.range<=40

  defensives:
    - ironbark,cycle=tanks,if=cycle.health.pct<50&cycle.range>0&cycle.range<=40
    - ironbark,cycle=healers,if=cycle.health.pct<60&cycle.range>0&cycle.range<=40
    - ironbark,cycle=members,if=cycle.health.pct<60&cycle.range>0&cycle.range<=40    
    - barkskin,if=health.pct<70

  racials:
    - shadowmeld,if=target.threat>=3&!player.casting

  cooldowns:
    - convoke_the_spirits,if=group.count(cycle.health.pct<80)>=3
    - tranquility,if=group.count(cycle.health.pct<80)>=3&!player.moving
    - natures_swiftness,if=group.count(cycle.health.pct<60)>=1

  trinkets:
    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_1,if=!var.trinket1_living_silk&trinket_1.ready
    - trinket_2,if=!var.trinket2_living_silk&trinket_2.ready

  active_healing:
    - lifebloom,cycle=tanks,if=cycle.buff.lifebloom.remains<4.5
    - wild_growth,if=group.count(cycle.health.pct<85)>=3
    - swiftmend,cycle=members,if=cycle.health.pct<70
    - regrowth,cycle=members,if=cycle.health.pct<80
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.remains<3&cycle.health.pct<90
    - rejuvenation,cycle=tanks,if=cycle.buff.rejuvenation.down
    - natures_cure,cycle=members,if=cycle.dispelable.list
    - efflorescence,if=buff.efflorescence.remains<3

  utility:
    - innervate,if=mana.pct<60&player.combat

  catweave_st:
    - moonfire,if=debuff.moonfire.remains<3&debuff.moonfire.refreshable
    - rip,if=combo_points>=5&debuff.rip.refreshable
    - ferocious_bite,if=combo_points>=4&debuff.rip.remains>10
    - rake,if=debuff.rake.refreshable&combo_points<=3
    - shred,if=combo_points<5

  catweave_aoe:
    - moonfire,if=debuff.moonfire.remains<3&active_enemies>=2
    - rip,if=combo_points>=5&debuff.rip.refreshable
    - thrash,if=active_enemies>=3
    - swipe,if=active_enemies>=2
    - rake,if=debuff.rake.refreshable&combo_points<=3
    - shred

  catweave:
    - heart_of_the_wild,if=active_enemies>=2
    - call_action_list,name=catweave_aoe,if=active_enemies>=3
    - call_action_list,name=catweave_st

  moving:
    - lifebloom,cycle=tanks
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.down&cycle.health.pct<95

  mouseover_friendly:
    - rejuvenation.mouseover,mouseover.health.pct<=99&mouseover.buff.remains(rejuvenation)=0
    - regrowth.mouseover,mouseover.health.pct<=95
    - purify.mouseover,if=mouseover.dispelable.list

  main:
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_target_ranged    
    - call_action_list,name=out_of_combat,if=!player.combat
    - return,if=!player.combat
    - return,if=player.channeling
    - call_action_list,name=interrupts
    - call_action_list,name=racials
    - call_action_list,name=defensives
    - call_action_list,name=utility
    - call_action_list,name=cooldowns
    #- call_action_list,name=mouseover_friendly,var.mo_friendly_valid&!player.casting&!player.channeling    
    - call_action_list,name=trinkets
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=active_healing
    - call_action_list,name=catweave,if=var.can_catweave&target.valid
