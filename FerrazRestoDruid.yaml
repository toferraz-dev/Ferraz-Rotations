version: 3.1
author: Ferraz
patch: "12.0.1"
spec: 105
name: Restoration Druid
description: |
  Restoration Druid - Wildstalker for Mythic+.
  Talent Tree: CkGA8cL7tpvige+kkmGM9zUPWPMmxYGzMjZb4BYmZhZx2MAAAAAAAAAAYbQzmhpZGzYMLMzMzyMwAAAAAAAYMAAEAAwsN2aWMsxYGYmZB0MAAzMAA
entry: main

config:
  # =================================================================================================
  #     DEFENSIVE & SURVIVAL
  # =================================================================================================
  barkskin_threshold:
    label: "Barkskin HP %"
    type: slider
    min: 25
    max: 99
    default: 55

  frenzied_regen_threshold:
    label: "Frenzied Regen HP %"
    type: slider
    min: 25
    max: 99
    default: 40

  ironbark_threshold:
    label: "Ironbark HP %"
    type: slider
    min: 25
    max: 99
    default: 55

  # =================================================================================================
  #     MAJOR COOLDOWNS
  # =================================================================================================
  convoke_threshold:
    label: "Convoke HP %"
    type: slider
    min: 25
    max: 99
    default: 65

  convoke_members:
    label: "Convoke - Min Members"
    type: slider
    min: 1
    max: 5
    default: 3

  tranquility_threshold:
    label: "Tranquility HP %"
    type: slider
    min: 25
    max: 99
    default: 65

  tranquility_members:
    label: "Tranquility - Min Members"
    type: slider
    min: 1
    max: 5
    default: 3

  ns_threshold:
    label: "Nature's Swiftness HP %"
    type: slider
    min: 25
    max: 99
    default: 45

  # =================================================================================================
  #     HEALING - AOE & GROUP
  # =================================================================================================
  use_mouseover:
    label: "Mouseover Healing (Emergency)"
    type: checkbox
    default: true

  mouseover_emergency_hp:
    label: "Mouseover Emergency HP %"
    type: slider
    min: 10
    max: 99
    default: 40

  wild_growth_threshold:
    label: "Wild Growth HP %"
    type: slider
    min: 25
    max: 99
    default: 85

  wild_growth_members:
    label: "Wild Growth - Min Members"
    type: slider
    min: 1
    max: 5
    default: 3

  # =================================================================================================
  #     HEALING - SINGLE TARGET
  # =================================================================================================
  swiftmend_threshold:
    label: "Swiftmend HP %"
    type: slider
    min: 25
    max: 99
    default: 70

  regrowth_threshold:
    label: "Regrowth HP %"
    type: slider
    min: 25
    max: 99
    default: 80

  rejuvenation_threshold:
    label: "Rejuvenation HP %"
    type: slider
    min: 25
    max: 99
    default: 90

  # =================================================================================================
  #     DAMAGE & CATWEAVING
  # =================================================================================================
  catweave_group_hp:
    label: "Enter Cat - Group HP %"
    type: slider
    min: 25
    max: 99
    default: 80

  catweave_injured_max:
    label: "Exit Cat - Max Injured"
    type: slider
    min: 0
    max: 5
    default: 2

  aoe_threshold:
    label: "AoE - Min Enemies"
    type: slider
    min: 2
    max: 5
    default: 3

  # =================================================================================================
  #     UTILITY & ITEMS
  # =================================================================================================
  innervate_threshold:
    label: "Innervate Mana %"
    type: slider
    min: 25
    max: 99
    default: 60

  living_silk_members:
    label: "Living Silk - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  living_silk_hp:
    label: "Living Silk HP %"
    type: slider
    min: 25
    max: 99
    default: 70

  use_dispell:
    label: "Enable Dispell"
    type: checkbox
    default: true

variables:
  group_healthy: group.count(cycle.health.pct<config.catweave_group_hp)<config.catweave_injured_max
  can_catweave: var.group_healthy&player.combat
  trinket1_living_silk: trinket_1.id=242393
  trinket2_living_silk: trinket_2.id=242393
  mo_friendly_valid: mouseover.exists&mouseover.alive&mouseover.friendly&mouseover.range>0&mouseover.range<=40

lists:
  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs
    - return,if=player.cc
    - return,if=player.loot_nearby
  
  interrupts:
    - incapacitating_roar,if=target.casting.interruptible
    - soothe,if=target.purgeable.enrage    
  
  out_of_combat:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>=0&cycle.range<=40)>0
    - symbiotic_relationship,cycle=tanks,if=cycle.buff.symbiotic_relationship.down&cycle.range>=0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.health.pct<config.rejuvenation_threshold&cycle.buff.rejuvenation.remains<1.5&!player.combat&cycle.range>=0&cycle.range<=40
    - regrowth,cycle=members,if=cycle.health.pct<config.regrowth_threshold&cycle.buff.regrowth.remains<1.5&!player.combat&cycle.range>=0&cycle.range<=40
    
    
  defensives:
    - natures_cure,cycle=members,if=config.use_dispell&cycle.dispelable.list&cycle.range>=0&cycle.range<=40
    - ironbark,cycle=members,if=cycle.health.pct<config.ironbark_threshold&cycle.buff.ironbark.down&cycle.range>=0&cycle.range<=40
    - barkskin,if=health.pct<config.barkskin_threshold
    - bear_form,if=health.pct<config.frenzied_regen_threshold&!buff.bear_form.up&cooldown.frenzied_regeneration.ready
    - frenzied_regeneration,if=health.pct<config.frenzied_regen_threshold&buff.bear_form.up

  racials:
    - shadowmeld,if=target.threat>=3&!player.casting

  cooldowns:
    - convoke_the_spirits,if=group.count(cycle.health.pct<config.convoke_threshold)>=config.convoke_members&!buff.cat_form.up&!buff.bear_form.up
    - tranquility,if=group.count(cycle.health.pct<config.tranquility_threshold)>=config.tranquility_members&!player.moving
    - natures_swiftness,if=group.count(cycle.health.pct<config.ns_threshold)>=1

  trinkets:
    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_1,if=!var.trinket1_living_silk&trinket_1.ready
    - trinket_2,if=!var.trinket2_living_silk&trinket_2.ready

  active_healing:
    # Nature's Swiftness follow-up: instant Regrowth on lowest
    - regrowth,cycle=members,if=buff.natures_swiftness.up&cycle.health.pct<config.regrowth_threshold&cycle.range>=0&cycle.range<=40
    - lifebloom,cycle=tanks,if=player.combat&cycle.buff.lifebloom.down&cycle.range>=0&cycle.range<=40&cycle.health.pct<95
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.remains<1.5&cycle.health.pct<config.rejuvenation_threshold&cycle.range>=0&cycle.range<=40    
    - swiftmend,cycle=members,if=cycle.health.pct<config.swiftmend_threshold&cycle.range>=0&cycle.range<=40
    - wild_growth,if=group.count(cycle.health.pct<config.wild_growth_threshold)>=config.wild_growth_members
    - regrowth,cycle=members,if=cycle.health.pct<config.regrowth_threshold&cycle.range>=0&cycle.range<=40
    
  utility:
    - innervate,if=mana.pct<config.innervate_threshold&player.combat

  catweave_st:
    - rip,if=combo_points>=5&debuff.rip.refreshable&target.range<=8
    - ferocious_bite,if=combo_points>=4&debuff.rip.remains>10&target.range<=8
    - rake,if=debuff.rake.refreshable&combo_points<=3&target.range<=8
    - shred,if=combo_points<5&target.range<=8

  catweave_aoe:
    - rip,if=combo_points>=5&debuff.rip.refreshable&target.range<=8
    - thrash,if=active_enemies>=config.aoe_threshold&target.range<=8
    - swipe,if=active_enemies>=config.aoe_threshold&target.range<=8
    - rake,if=debuff.rake.refreshable&combo_points<=3&target.range<=8
    - shred,if=target.range<=8

  catweave:
    # Emergency exit: leave cat if group needs healing
    - cancel_form,if=!var.group_healthy&buff.cat_form.up
    - return,if=!var.group_healthy
    - moonfire,if=debuff.moonfire.remains<2&debuff.moonfire.refreshable&!buff.cat_form.up
    - cat_form,if=!buff.cat_form.up&target.range<=8
    - return,if=!buff.cat_form.up
    - call_action_list,name=catweave_aoe,if=active_enemies>=config.aoe_threshold
    - call_action_list,name=catweave_st

  moving:
    - convoke_the_spirits,if=group.count(cycle.health.pct<config.convoke_threshold)>=config.convoke_members&!buff.cat_form.up&!buff.bear_form.up
    - lifebloom,cycle=tanks,if=player.combat&cycle.buff.lifebloom.down&cycle.range>=0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.down&cycle.health.pct<95&cycle.range>=0&cycle.range<=40

  mouseover_healing_emergency:
    - natures_cure.mouseover,if=config.use_dispell&mouseover.dispelable.list&mouseover.range>=0&mouseover.range<=40
    - regrowth.mouseover,if=buff.natures_swiftness.up&mouseover.range>=0&mouseover.range<=40
    - swiftmend.mouseover,if=mouseover.range>=0&mouseover.range<=40
    - regrowth.mouseover,if=mouseover.range>=0&mouseover.range<=40
    - rejuvenation.mouseover,if=mouseover.buff.remains(rejuvenation)<1.5&mouseover.range>=0&mouseover.range<=40

  main:
    - return,if=player.channeling
    - return,if=buff.tranquility.up
    - return,if=buff.convoke_the_spirits.up
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_target
    - call_action_list,name=auto_heal
    - call_action_list,name=out_of_combat
    - return,if=!player.combat
    - call_action_list,name=interrupts
    - call_action_list,name=racials
    - call_action_list,name=defensives
    - call_action_list,name=utility
    - call_action_list,name=cooldowns
    - call_action_list,name=trinkets
    - call_action_list,name=mouseover_healing_emergency,if=config.use_mouseover&var.mo_friendly_valid&(mouseover.health.pct<config.mouseover_emergency_hp|mouseover.dispelable.list)&!player.casting&!player.channeling
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=active_healing
    - call_action_list,name=catweave,if=var.can_catweave&target.exists&target.alive&!target.friendly