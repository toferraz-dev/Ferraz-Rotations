version: 2.3
author: Ferraz
spec: 105
name: Restoration Druid
description: |
  Restoration Druid - Wildstalker for Mythic+.
  
entry: main

config:
  # DEFENSIVE COOLDOWNS
  ironbark_threshold:
    label: "Ironbark HP %"
    type: slider
    min: 25
    max: 99
    default: 60

  barkskin_threshold:
    label: "Barkskin HP %"
    type: slider
    min: 25
    max: 99
    default: 60

  healthstone_threshold:
    label: "Healthstone HP %"
    type: slider
    min: 25
    max: 99
    default: 65

  health_potion_threshold:
    label: "Health Potion HP %"
    type: slider
    min: 25
    max: 99
    default: 50

  # MAJOR COOLDOWNS
  convoke_threshold:
    label: "Convoke HP %"
    type: slider
    min: 25
    max: 99
    default: 70

  convoke_members:
    label: "Convoke - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  tranquility_threshold:
    label: "Tranquility HP %"
    type: slider
    min: 25
    max: 99
    default: 80

  tranquility_members:
    label: "Tranquility - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  ns_threshold:
    label: "Nature's Swiftness HP %"
    type: slider
    min: 25
    max: 99
    default: 60

  # HEALING THRESHOLDS
  wild_growth_threshold:
    label: "Wild Growth HP %"
    type: slider
    min: 25
    max: 99
    default: 80

  wild_growth_members:
    label: "Wild Growth - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  swiftmend_threshold:
    label: "Swiftmend HP %"
    type: slider
    min: 25
    max: 99
    default: 60

  regrowth_threshold:
    label: "Regrowth HP %"
    type: slider
    min: 25
    max: 99
    default: 75

  rejuvenation_threshold:
    label: "Rejuvenation HP %"
    type: slider
    min: 25
    max: 99
    default: 85

  # CATWEAVING
  catweave_group_hp:
    label: "Catweave - Group HP %"
    type: slider
    min: 25
    max: 99
    default: 60

  catweave_injured_max:
    label: "Catweave - Max Injured"
    type: slider
    min: 0
    max: 5
    default: 2

  aoe_threshold:
    label: "AoE - Enemies"
    type: slider
    min: 2
    max: 5
    default: 3

  # UTILITY
  innervate_threshold:
    label: "Innervate Mana %"
    type: slider
    min: 25
    max: 99
    default: 60

  # TRINKETS
  living_silk_members:
    label: "Living Silk - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  living_silk_hp:
    label: "Living Silk HP %"
    type: slider
    min: 25
    max: 99
    default: 70

variables:
  group_healthy: group.count(cycle.health.pct<config.catweave_group_hp)<config.catweave_injured_max
  can_catweave: var.group_healthy&player.combat
  trinket1_living_silk: trinket_1.id=242393
  trinket2_living_silk: trinket_2.id=242393

lists:
  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs
  
  interrupts:
    - incapacitating_roar,if=active_enemies>=config.aoe_threshold&target.casting.interruptible
    - soothe,if=target.purgeable.enrage    
  
  out_of_combat:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>=0&cycle.range<=40)>0
    - symbiotic_relationship,cycle=tanks,if=cycle.buff.symbiotic_relationship.down&cycle.range>=0&cycle.range<=40
    - regrowth,cycle=members,if=cycle.health.pct<95&cycle.buff.regrowth.remains<1.5&!player.combat&cycle.range>=0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.health.pct<95&cycle.buff.rejuvenation.remains<1.5&!player.combat&cycle.range>=0&cycle.range<=40    
    
  defensives:
    - natures_cure,cycle=members,if=cycle.dispelable.list&cycle.range>=0&cycle.range<=40
    - healthstone,if=health.pct<=config.healthstone_threshold
    - health_potion,if=health.pct<=config.health_potion_threshold
    - ironbark,cycle=members,if=cycle.health.pct<config.ironbark_threshold&cycle.buff.ironbark.down&cycle.range>=0&cycle.range<=40
    - barkskin,if=health.pct<config.barkskin_threshold

  racials:
    - shadowmeld,if=target.threat>=3&!player.casting

  cooldowns:
    - convoke_the_spirits,if=group.count(cycle.health.pct<config.convoke_threshold)>=config.convoke_members&!buff.cat_form.up&!buff.bear_form.up
    - tranquility,if=group.count(cycle.health.pct<config.tranquility_threshold)>=config.tranquility_members&!player.moving
    - natures_swiftness,if=group.count(cycle.health.pct<config.ns_threshold)>=1

  trinkets:
    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members
    - trinket_1,if=!var.trinket1_living_silk&trinket_1.ready
    - trinket_2,if=!var.trinket2_living_silk&trinket_2.ready

  active_healing:
    - lifebloom,cycle=tanks,if=cycle.buff.lifebloom.down&cycle.range>=0&cycle.range<=40
    - wild_growth,if=group.count(cycle.health.pct<config.wild_growth_threshold)>=config.wild_growth_members
    - swiftmend,cycle=members,if=cycle.health.pct<config.swiftmend_threshold&cycle.range>=0&cycle.range<=40
    - regrowth,cycle=members,if=cycle.health.pct<config.regrowth_threshold&cycle.range>=0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.remains<1.5&cycle.health.pct<config.rejuvenation_threshold&cycle.range>=0&cycle.range<=40
    - efflorescence,if=buff.efflorescence.remains<1

  utility:
    - innervate,if=mana.pct<config.innervate_threshold&player.combat

  catweave_st:
    - 1261868,if=target.range<=8
    - rip,if=combo_points>=5&debuff.rip.refreshable&target.range<=8
    - ferocious_bite,if=combo_points>=4&debuff.rip.remains>10&target.range<=8
    - rake,if=debuff.rake.refreshable&combo_points<=3&target.range<=8
    - shred,if=combo_points<5&target.range<=8

  catweave_aoe:
    - 1261868,if=target.range<=8
    - rip,if=combo_points>=5&debuff.rip.refreshable&target.range<=8
    - thrash,if=active_enemies>=config.aoe_threshold&target.range<=8
    - swipe,if=active_enemies>=config.aoe_threshold&target.range<=8
    - rake,if=debuff.rake.refreshable&combo_points<=3&target.range<=8
    - shred,if=target.range<=8

  catweave:
    - moonfire,if=debuff.moonfire.remains<2&debuff.moonfire.refreshable&!buff.cat_form.up
    - cat_form,if=!buff.cat_form.up&target.range<=8
    - return,if=!buff.cat_form.up
    - call_action_list,name=catweave_aoe,if=active_enemies>=config.aoe_threshold
    - call_action_list,name=catweave_st

  moving:
    - lifebloom,cycle=tanks,if=cycle.buff.lifebloom.down&cycle.range>=0&cycle.range<=40
    - rejuvenation,cycle=members,if=cycle.buff.rejuvenation.down&cycle.health.pct<95&cycle.range>=0&cycle.range<=40

  main:
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_target_ranged    
    - call_action_list,name=out_of_combat,if=!player.combat
    - return,if=!player.combat
    - return,if=player.channeling
    - call_action_list,name=interrupts
    - call_action_list,name=racials
    - call_action_list,name=defensives
    - call_action_list,name=utility
    - call_action_list,name=cooldowns
    - call_action_list,name=trinkets
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=active_healing
    - call_action_list,name=catweave,if=var.can_catweave&target.valid
