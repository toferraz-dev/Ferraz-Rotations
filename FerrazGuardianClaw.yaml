version: 1.0
author: Ferraz
spec: 104
name: Guardian Claw
description: |
  Guardian Druid - Druid of the Claw for Mythic+.
  Supports Wowhead (aggressive DPS) and Method.gg (balanced) rotation styles.
  Optional catweaving for extra DPS when safe.
  Talent Build: CgGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgZmxswMMziZZegZmZZZAbzwoJyMziZmZmlhhBAAAAwgZsNDAAAAGjZZGzAAYBzAYxMYALWMAYmN

entry: main

config:

  # ROTATION STYLE
  rotation_source:
    label: "Rotation Style"
    type: dropdown
    options:
      - label: "Wowhead (Aggressive DPS)"
        value: 1
      - label: "Method.gg (Balanced)"
        value: 2
    default: 2

  # CATWEAVING
  enable_catweaving:
    label: "Enable Catweaving"
    type: checkbox
    default: false
  catweave_hp_threshold:
    label: "Min HP% to Catweave"
    type: slider
    min: 40
    max: 90
    default: 70

  # CONFIG
  allow_pull_with_mo:
    label: "Pull with Moonfire"
    type: checkbox
    default: true
  survival_instincts_threshold:
    label: Survival Instincts %
    type: slider
    min: 10
    max: 70
    default: 50
  frenzied_regen_threshold:
    label: Frenzied Regeneration %
    type: slider
    min: 30
    max: 80
    default: 65
  barkskin_threshold:
    label: Barkskin %
    type: slider
    min: 30
    max: 90
    default: 65
  ironfur_stacks_min:
    label: "Min Ironfur Stacks to maintain"
    type: slider
    min: 1
    max: 7
    default: 3
  ironfur_stacks_max:
    label: "Max Ironfur Stacks (heavy damage)"
    type: slider
    min: 3
    max: 10
    default: 5
  ironfur_rage_threshold:
    label: "Min Rage for Ironfur"
    type: slider
    min: 30
    max: 80
    default: 40
  rage_cap_threshold:
    label: "Rage Cap Threshold (dump)"
    type: slider
    min: 60
    max: 100
    default: 80

  # MAJOR COOLDOWNS
  incarnation_enemies:
    label: "Min enemies for Incarnation"
    type: slider
    min: 1
    max: 10
    default: 3
  rage_of_sleeper_threshold:
    label: "HP% for Rage of the Sleeper"
    type: slider
    min: 30
    max: 90
    default: 70

  # ROTATION
  thrash_stacks_target:
    label: "Thrash Stacks to maintain"
    type: slider
    min: 1
    max: 5
    default: 3
  raze_targets:
    label: "Min targets for Raze (instead of Maul)"
    type: slider
    min: 2
    max: 5
    default: 2

  # INTERRUPTS
  use_skull_bash:
    label: "Auto Interrupt"
    type: checkbox
    default: true
  skull_bash_delay:
    label: "Interrupt Delay (ms)"
    type: slider
    min: 0
    max: 2000
    default: 250

  # MOVEMENT
  stampeding_roar_usage:
    label: "Stampeding Roar Usage"
    type: dropdown
    options:
      - label: "Disabled"
        value: 0
      - label: "Only in combat"
        value: 1
      - label: "Only out of combat"
        value: 2
      - label: "Always when moving"
        value: 3
    default: 2
  stampeding_roar_movement_time:
    label: "Roar after moving (seconds)"
    type: slider
    min: 0
    max: 4
    default: 2

  # TRINKETS
  trinket_usage:
    label: "Trinket Usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "With Incarnation"
        value: 2
      - label: "When taking damage"
        value: 3
      - label: "Manual Only"
        value: 0
    default: 1

variables:
  # FORM AND RESOURCES
  in_bear_form: buff.bear_form.up
  in_cat_form: buff.cat_form.up
  rage: player.rage
  rage_deficit: player.rage.max-player.rage
  rage_overcap: var.rage>=config.rage_cap_threshold
  rage_for_maul: var.rage>=40

  # DEFENSIVE BUFFS
  ironfur_stacks: buff.ironfur.stack
  need_ironfur: var.ironfur_stacks<config.ironfur_stacks_min&var.rage>=config.ironfur_rage_threshold
  heavy_damage: health.pct<70&var.ironfur_stacks<config.ironfur_stacks_max
  dangerous_situation: health.pct<50&!buff.survival_instincts.up
  emergency_situation: health.pct<30
  barkskin_up: buff.barkskin.up
  survival_up: buff.survival_instincts.up
  any_major_defensive: var.barkskin_up|var.survival_up|buff.rage_of_the_sleeper.up
  after_avenger_up: buff.after_the_wildfire.up

  # DRUID OF THE CLAW PROCS
  ravage_ready: buff.ravage.up
  dreadful_wound_up: debuff.dreadful_wound.up
  dreadful_wound_needs_refresh: debuff.dreadful_wound.remains<3

  # OFFENSIVE PROCS
  galactic_guardian_up: buff.galactic_guardian.up
  tooth_and_claw_up: buff.tooth_and_claw.up
  gore_up: buff.gore.up
  mangle_charges: cooldown.mangle.charges

  # CATWEAVING
  feline_potential_stacks: buff.feline_potential.stack
  catweave_ready: config.enable_catweaving&var.feline_potential_stacks>=6&health.pct>=config.catweave_hp_threshold&var.in_bear_form
  catweave_safe: health.pct>=config.catweave_hp_threshold&var.ironfur_stacks>=2

  # DOT TRACKING
  thrash_stacks: debuff.thrash.stack
  thrash_target_stacks: config.thrash_stacks_target
  thrash_needs_refresh: debuff.thrash.remains<4.5|debuff.thrash.stack<var.thrash_target_stacks
  moonfire_needs_refresh: debuff.moonfire.remains<4.8

  # COOLDOWN STATES
  incarnation_active: buff.incarnation_guardian_of_ursoc.up
  berserk_active: buff.berserk.up
  burst_active: var.incarnation_active|var.berserk_active
  combat_start: player.combat&player.combat.time<3

  # TARGETING
  use_raze: active_enemies>=config.raze_targets
  can_interrupt: target.casting&!target.casting.interruptible=false

  # MOVEMENT
  use_stampeding_roar: moving.time>=config.stampeding_roar_movement_time&buff.stampeding_roar.down&((config.stampeding_roar_usage=1&player.combat)|(config.stampeding_roar_usage=2&!player.combat)|(config.stampeding_roar_usage=3))

  # RACIAL THRESHOLDS
  racial_defensive_hp: 50
  racial_emergency_hp: 35

lists:

  spell_queue:
    - queue_spell

  buff_mark_of_the_wild:
    - mark_of_the_wild,if=group.count(cycle.buff.mark_of_the_wild.down.any&cycle.range>0&cycle.range<=40)>0

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs

  defensives:
    - survival_instincts,if=var.emergency_situation&!var.survival_up
    - rage_of_the_sleeper,if=var.emergency_situation&!var.survival_up
    - frenzied_regeneration,if=var.emergency_situation&var.rage>=10
    - barkskin,if=var.emergency_situation&!var.survival_up
    - survival_instincts,if=var.dangerous_situation&!var.barkskin_up
    - frenzied_regeneration,if=var.dangerous_situation&var.rage>=20
    - ironfur,if=var.dangerous_situation&var.rage>=40
    - survival_instincts,if=health.pct<config.survival_instincts_threshold&cooldown.frenzied_regeneration.remains>2&!var.any_major_defensive
    - frenzied_regeneration,if=health.pct<config.frenzied_regen_threshold
    - barkskin,if=health.pct<config.barkskin_threshold&!var.survival_up
    - ironfur,if=var.after_avenger_up&var.ironfur_stacks<config.ironfur_stacks_max
    - ironfur,if=var.heavy_damage&var.rage>=40
    - ironfur,if=var.burst_active&var.ironfur_stacks<config.ironfur_stacks_max&var.rage>=45

  cooldowns:
    - incarnation_guardian_of_ursoc,if=active_enemies>=config.incarnation_enemies|(target.boss&target.time_to_die>20)
    - rage_of_the_sleeper,if=health.pct<config.rage_of_sleeper_threshold|active_enemies>=4|(var.burst_active&active_enemies>=3)
    - berserk_ravage,if=talent.berserk_ravage&(active_enemies>=3|target.boss)
    - heart_of_the_wild,if=var.in_bear_form&active_enemies>=4

  interrupts:
    - skull_bash,if=config.use_skull_bash&var.can_interrupt,delay=config.skull_bash_delay
    - soothe,if=target.purgeable.enrage
    - incapacitating_roar,if=active_enemies>=3&talent.incapacitating_roar

  dispel:
    - remove_corruption,cycle=members,if=cycle.dispelable.list&cycle.range>0&cycle.range<=40

  taunt:
    - growl,target=mouseover,if=target.threat<3&target.range<=30&target.alive&target.enemy
    - growl,if=target.threat<3&target.range<=30

  rage_management:
    - ironfur,if=var.need_ironfur
    - ironfur,if=var.ironfur_stacks<config.ironfur_stacks_max&var.rage>=60&buff.ironfur.remains<3
    - ravage,if=var.ravage_ready&var.use_raze
    - ravage,if=var.ravage_ready&!var.use_raze
    - maul,if=var.tooth_and_claw_up&var.rage>=35&!var.use_raze
    - raze,if=var.use_raze&var.rage_overcap
    - maul,if=var.burst_active&var.rage>=50&!var.use_raze
    - maul,if=!var.use_raze&var.rage_overcap

  moonfire_spread:
    - moonfire,if=var.combat_start&debuff.moonfire.down&range<=40
    - moonfire,if=var.burst_active&debuff.moonfire.down&range<=40
    - moonfire,if=var.galactic_guardian_up
    - moonfire,if=var.moonfire_needs_refresh
    - moonfire,if=debuff.moonfire.down
    - moonfire,target=mouseover,if=debuff.moonfire.down&range<=40&target.alive&target.enemy

  catweaving:
    - rake,if=var.catweave_ready&var.catweave_safe
    - rip,if=var.in_cat_form&combo_points>=4
    - ferocious_bite,if=var.in_cat_form&combo_points>=4&debuff.rip.up
    - bear_form,if=var.in_cat_form

  # WOWHEAD ROTATIONS (Aggressive DPS)

  rotation_st_wowhead:
    - ravage,if=var.ravage_ready
    - moonfire,if=var.moonfire_needs_refresh
    - thrash,if=debuff.thrash.stack<var.thrash_target_stacks
    - mangle,if=var.gore_up
    - mangle
    - maul,if=var.rage>=40&var.ironfur_stacks>=1&var.tooth_and_claw_up
    - maul,if=var.rage_overcap&var.ironfur_stacks>=1
    - thrash
    - moonfire,if=var.galactic_guardian_up
    - swipe

  rotation_aoe_wowhead:
    - ravage,if=var.ravage_ready
    - thrash,if=debuff.thrash.stack<var.thrash_target_stacks
    - raze,if=var.rage>=40&var.ironfur_stacks>=1
    - thrash
    - mangle,if=var.gore_up
    - mangle
    - call_action_list,name=moonfire_spread
    - swipe

  # METHOD.GG ROTATIONS (Balanced)

  rotation_st_method:
    - ravage,if=var.ravage_ready
    - mangle,if=var.gore_up
    - mangle,if=var.mangle_charges>=2
    - mangle
    - thrash,if=var.thrash_needs_refresh
    - moonfire,if=var.galactic_guardian_up
    - moonfire,if=var.moonfire_needs_refresh
    - maul,if=var.rage_overcap&var.tooth_and_claw_up
    - maul,if=var.rage_overcap
    - thrash
    - swipe

  rotation_aoe_method:
    - ravage,if=var.ravage_ready
    - thrash,if=var.thrash_needs_refresh
    - mangle,if=var.gore_up
    - mangle,if=var.mangle_charges>=2
    - thrash
    - mangle
    - call_action_list,name=moonfire_spread
    - raze,if=var.rage_overcap
    - raze,if=var.rage>=40&var.tooth_and_claw_up
    - raze,if=var.rage>=40
    - swipe

  # RACIAL ABILITIES

  racial_defensive:
    - stoneform,if=player.dispelable.list
    - fireblood,if=player.dispelable.list
    - will_of_the_forsaken,if=player.feared|player.charmed
    - escape_artist,if=player.rooted
    - will_to_survive,if=player.stunned
    - gift_of_the_naaru.player,if=health.pct<var.racial_emergency_hp
    - regeneratin,if=health.pct<var.racial_emergency_hp&!player.combat
    - stoneform,if=health.pct<var.racial_defensive_hp
    - fireblood,if=health.pct<var.racial_defensive_hp

  racial_offensive:
    - berserking,if=var.burst_active
    - blood_fury,if=var.burst_active
    - ancestral_call,if=var.burst_active
    - fireblood,if=var.burst_active&!player.dispelable.list
    - azerite_surge,if=var.burst_active

  racial_cc:
    - war_stomp,if=interrupts.8y.stun.count>=1
    - quaking_palm,if=target.casting.interruptible
    - haymaker,if=target.casting.interruptible
    - bull_rush,if=target.casting.interruptible
    - wing_buffet,if=target.casting.interruptible
    - arcane_pulse,if=enemies.8y.count>=3

  racial_utility:
    - arcane_torrent,if=var.rage<50
    - gift_of_the_naaru,cycle=members,if=cycle.health.pct<60&cycle.range>0&cycle.range<=40

  trinkets:
    - trinket_1,if=trinket_1.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&var.burst_active)|(config.trinket_usage=3&health.pct<70))
    - trinket_2,if=trinket_2.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&var.burst_active)|(config.trinket_usage=3&health.pct<70))

  movement:
    - stampeding_roar,if=var.use_stampeding_roar&config.stampeding_roar_usage!=0

  main:
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=buff_mark_of_the_wild
    - bear_form,if=!var.in_bear_form&!var.in_cat_form&player.combat&!mounted.flying&!mounted.ground
    - moonfire,if=config.allow_pull_with_mo&!player.combat&target.enemy&target.alive&debuff.moonfire.down
    - return,if=!player.combat&active_enemies=0
    - return,if=player.channeling
    - call_action_list,name=auto_target
    - call_action_list,name=auto_heal
    - call_action_list,name=taunt
    - call_action_list,name=interrupts
    - call_action_list,name=racial_cc
    - call_action_list,name=racial_defensive
    - call_action_list,name=dispel
    - call_action_list,name=catweaving,if=config.enable_catweaving&var.in_cat_form
    - bear_form,if=var.in_cat_form&(health.pct<config.catweave_hp_threshold|!config.enable_catweaving)
    - call_action_list,name=defensives,if=var.in_bear_form
    - call_action_list,name=cooldowns,if=var.in_bear_form
    - call_action_list,name=racial_offensive,if=var.burst_active
    - call_action_list,name=rage_management,if=var.in_bear_form
    - call_action_list,name=movement,if=player.moving
    - call_action_list,name=racial_utility
    - call_action_list,name=trinkets
    - call_action_list,name=catweaving,if=var.catweave_ready&var.in_bear_form
    - call_action_list,name=rotation_aoe_wowhead,if=config.rotation_source=1&active_enemies>=3&var.in_bear_form
    - call_action_list,name=rotation_st_wowhead,if=config.rotation_source=1&var.in_bear_form
    - call_action_list,name=rotation_aoe_method,if=config.rotation_source=2&active_enemies>=3&var.in_bear_form
    - call_action_list,name=rotation_st_method,if=config.rotation_source=2&var.in_bear_form
